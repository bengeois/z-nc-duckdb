# z-nc-duckdb

Zenika - NightClazz DuckDB

A project focused on analyzing the Nantes transportation system using DuckDB, with tools to generate realistic validation data from GTFS (General Transit Feed Specification) datasets.

## üìä Data Source

Complete dataset of Nantes transportation system: 
https://data.nantesmetropole.fr/explore/dataset/244400404_transports_commun_naolib_nantes_metropole_gtfs/table/

Neighborhood dataset for Nantes municipalities:
https://data.nantesmetropole.fr/explore/dataset/244400404_quartiers-communes-nantes-metropole/table/

Fake ticket validation dataset generated by a Go or JS script:
[validation-generator](/validation-generator/)

## üõ†Ô∏è Installation

0. [Install DuckDB](https://duckdb.org/docs/installation/) or use the [DuckDB Web Shell](https://shell.duckdb.org/)

1. Clone the repository:
   ```bash
   git clone <repository-url>
   cd z-nc-duckdb
   ```

2. Download the GTFS data:
   ```bash
   sh open-data-naolib/init_db.sh
   ```

3. Download the neighborhood datasets:
   ```bash
   sh open-data-naoned/init_file.sh
   ```

4. Generate validation data
   Navigate to the Go generator and ensure you have Go 1.23+ installed:
   ```bash
   cd validation-generator/go
   go version
   ```
   If yes, start generation:
   ```bash
   # ‚ö†Ô∏è 100000000 -> ~15Go
   go run main.go 100000000 2025-06-22
   ```
   If not, a JS alternative is available, look at [validation-generator](/validation-generator/)

5. Now you're ready to start codelab üéâ

## üß™ Codelab

First, use DuckDB to check the number of validations contained in the `data/validations.json` file.

<details>
  <summary>Spoiler</summary>

  ```sql
  select count(*) from 'data/validations.json';
  ```

</details>

> Note you could use `.timer on` to enable the SQL timer (or `PRAGMA enable_profiling;` for more detailled informations)

JSON isn't an optimized format for what we want, so we'll have to convert it into parquet first.

Try it with DuckDB and check the number of validations contained in the newly created `data/validations.parquet` file.

<details>
  <summary>Spoiler</summary>

  ```sql
  copy (from 'data/validations.json') to 'data/validations.parquet';
  select count(*) from 'data/validations.parquet';
  ```

</details>

> Note that you can use `describe 'data/validations.parquet'` and `summarize 'data/validations.parquet'` to find out more about a dataset.

Use the previous datasets to perform the analyses below.

<details>
<summary>Spoiler</summary>

To attach the Naolib dataset:
```sql
attach 'data/open-data-naolib.duckdb' as naolib;
from naolib.stops;
```
You can also use the files directly (`from read_csv('data/open-data-naolib/stops.txt')`).

To load the Naoned dataset:
```sql
create table quartiers as (from 'data/open-data-naoned-quartiers.parquet');
```
You can also use the file directly (`from 'data/open-data-naoned-quartiers.parquet'`).

To read the file of validations:
```sql
from 'data/validations.parquet';
```

</details>

1. **Analysis of ridership by stop**  
   Identify the busiest stops (`validations`, `stops`).

2. **Temporal analysis of validations**  
   Understand peak traffic by time of day or day of week (`validations`).

3. **Geographical distribution of stops and validations**  
   Associate each stop with a neighborhood via its coordinates, then analyze ridership by neighborhood (`validations`, `stops`, `quartiers`).
   <details>
   <summary>Hint</summary>

   You may need the [Spatial Extension](https://duckdb.org/docs/stable/core_extensions/spatial/overview.html):
   ```sql
   install spatial;
   load spatial;
   ```

   </details>

4. **Store `quartiers` in another database**  
   Use DuckDB to insert data into a SQLite (or PostgreSQL, ‚Ä¶) and load it.

5. **Use DuckLake to store and query in the cloud**  
   Choose a [Catalog Database](https://ducklake.select/docs/stable/duckdb/usage/choosing_a_catalog_database) and a [Storage](https://ducklake.select/docs/stable/duckdb/usage/choosing_storage), for a local samples take a look at [simulate-pg-and-s3](/simulate-pg-and-s3/).  
   Add a few validations to DuckLake and see what happens.

## üîó Related Resources

- [DuckDB Documentation](https://duckdb.org/docs/)
- [DuckLake Documentation](https://ducklake.select/docs/)
- [GTFS Reference](https://gtfs.org/reference/)
- [Nantes Open Data Portal](https://data.nantesmetropole.fr/)
- [Go Documentation](https://golang.org/doc/)
